<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RandomChat - Connect Anonymously</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        // Analytics ID will be set dynamically by server
        gtag('config', 'G-XXXXXXXXXX');
    </script>
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0000000000000000" crossorigin="anonymous"></script>
    <style>
        /* All CSS from omg.html goes here */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; color: white; }
        .header h1 { font-size: 3rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .online-counter { background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 25px; display: inline-block; backdrop-filter: blur(10px); margin-bottom: 20px; }
        .setup-panel { background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); backdrop-filter: blur(10px); }
        .chat-type-selector { display: flex; gap: 20px; margin-bottom: 30px; justify-content: center; }
        .chat-type-btn { padding: 15px 30px; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 10px; }
        .chat-type-btn.active { background: #667eea; color: white; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .chat-type-btn:not(.active) { background: #f8f9fa; color: #333; }
        .filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { margin-bottom: 8px; font-weight: 600; color: #555; }
        .filter-group select, .filter-group input { padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; transition: border-color 0.3s ease; }
        .filter-group select:focus, .filter-group input:focus { outline: none; border-color: #667eea; }
        .start-chat-btn { background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 15px 40px; font-size: 18px; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; display: block; margin: 0 auto; min-width: 200px; }
        .start-chat-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3); }
        .start-chat-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .chat-container { display: none; background: white; border-radius: 15px; padding: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); height: 600px; position: relative; }
        .chat-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 2px solid #f1f3f4; margin-bottom: 20px; }
        .stranger-info { color: #667eea; font-weight: 600; }
        .chat-controls { display: flex; gap: 10px; }
        .control-btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; }
        .end-chat-btn { background: #dc3545; color: white; }
        .next-chat-btn { background: #28a745; color: white; }
        .video-container { display: none; height: 400px; margin-bottom: 20px; position: relative; background: #000; border-radius: 10px; overflow: hidden; }
        .video-container.active { display: block; }
        #remoteVideo { width: 100%; height: 100%; object-fit: cover; }
        #localVideo { position: absolute; top: 10px; right: 10px; width: 150px; height: 100px; object-fit: cover; border: 2px solid white; border-radius: 8px; background: #333; }
        .video-controls { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; }
        .video-control-btn { background: rgba(0,0,0,0.7); color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; }
        .video-control-btn:hover { background: rgba(0,0,0,0.9); transform: scale(1.1); }
        .chat-messages { height: 300px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f8f9fa; }
        .video-container.active + .chat-messages { height: calc(600px - 20px - 70px - 400px - 20px - 60px); }
        .message { margin-bottom: 12px; padding: 8px 12px; border-radius: 8px; max-width: 80%; word-wrap: break-word; }
        .message.own { background: #667eea; color: white; margin-left: auto; text-align: right; }
        .message.other { background: white; border: 1px solid #e9ecef; }
        .message.system { background: #f0f0f0; color: #666; text-align: center; font-style: italic; margin: 0 auto; }
        .chat-input-container { display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; }
        .chat-input:focus { outline: none; border-color: #667eea; }
        .send-btn { background: #667eea; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
        .send-btn:hover { background: #5a6fd8; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; color: white; font-weight: 600; z-index: 1000; transform: translateX(400px); transition: transform 0.3s ease; }
        .notification.show { transform: translateX(0); }
        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.info { background: #17a2b8; }
        @media (max-width: 768px) { .container { padding: 10px; } .header h1 { font-size: 2rem; } .chat-type-selector { flex-direction: column; align-items: center; } .filters { grid-template-columns: 1fr; } .video-container { height: 300px; } #localVideo { width: 100px; height: 75px; } }
        
        /* Ad placement styles */
        .ad-banner { margin: 10px 0; text-align: center; min-height: 90px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; display: flex; align-items: center; justify-content: center; }
        .ad-banner.header-ad { margin: 20px 0; }
        .ad-banner.sidebar-ad { width: 300px; height: 250px; margin: 20px auto; }
        .ad-banner.footer-ad { margin: 30px 0; }
        .ad-placeholder { color: #6c757d; font-size: 14px; }
        .ads-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin: 20px 0; }
        @media (max-width: 768px) { .ad-banner.sidebar-ad { width: 100%; height: 200px; } }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Ad Banner -->
        <div class="ad-banner header-ad" id="headerAd">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-0000000000000000"
                 data-ad-slot="1234567890"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
        </div>
        
        <!-- HTML layout is identical to omg.html, so it's omitted here for brevity -->
        <div class="header">
            <h1>ðŸŽ­ RandomChat</h1>
            <div class="online-counter"><span id="onlineCount">0</span> users online</div>
        </div>
        
        <div class="ads-container">
            <!-- Sidebar Ad -->
            <div class="ad-banner sidebar-ad" id="sidebarAd">
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-0000000000000000"
                     data-ad-slot="0987654321"
                     data-ad-format="rectangle"></ins>
            </div>
        </div>
        <div id="setupPanel" class="setup-panel">
            <div class="chat-type-selector">
                <button class="chat-type-btn active" data-type="text">ðŸ’¬ Text Chat</button>
                <button class="chat-type-btn" data-type="video">ðŸ“¹ Video Chat</button>
            </div>
            <div class="filters">
                <div class="filter-group"><label for="genderFilter">Gender</label><select id="genderFilter"><option value="">Any</option><option value="male">Male</option><option value="female">Female</option><option value="other">Other</option></select></div>
                <div class="filter-group"><label for="locationFilter">Location</label><input type="text" id="locationFilter" placeholder="e.g., USA, Europe, Asia"></div>
                <div class="filter-group"><label for="ageFilter">Age Range</label><select id="ageFilter"><option value="">Any</option><option value="18-25">18-25</option><option value="26-35">26-35</option><option value="36-45">36-45</option><option value="46+">46+</option></select></div>
                <div class="filter-group"><label for="keywordsFilter">Interests/Keywords</label><input type="text" id="keywordsFilter" placeholder="e.g., music, sports, tech"></div>
            </div>
            <button id="startChatBtn" class="start-chat-btn">ðŸš€ Start Chatting</button>
        </div>
        <div id="chatContainer" class="chat-container">
            <div class="chat-header">
                <div class="stranger-info"><span id="strangerStatus">Connecting...</span></div>
                <div class="chat-controls">
                    <button id="nextChatBtn" class="control-btn next-chat-btn">Next</button>
                    <button id="endChatBtn" class="control-btn end-chat-btn">End Chat</button>
                </div>
            </div>
            <div id="videoContainer" class="video-container">
                <video id="remoteVideo" autoplay playsinline></video>
                <video id="localVideo" autoplay playsinline muted></video>
                <div class="video-controls">
                    <button id="toggleVideoBtn" class="video-control-btn" title="Toggle Video">ðŸ“¹</button>
                    <button id="toggleAudioBtn" class="video-control-btn" title="Toggle Audio">ðŸŽ¤</button>
                </div>
            </div>
            <div id="chatMessages" class="chat-messages">
                <div class="loading" id="loadingIndicator"><div class="spinner"></div>Looking for someone to chat with...</div>
            </div>
            <div class="chat-input-container">
                <input type="text" id="chatInput" class="chat-input" placeholder="Type your message..." disabled><button id="sendBtn" class="send-btn" disabled>Send</button>
            </div>
        </div>
        
        <!-- Footer Ad Banner -->
        <div class="ad-banner footer-ad" id="footerAd">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-0000000000000000"
                 data-ad-slot="1122334455"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // This is the new, functional client-side script
        class RandomChatApp {
            constructor() {
                this.socket = null;
                this.pc = null; // PeerConnection
                this.localStream = null;
                this.chatType = 'text';
                this.userId = null;
                this.chatId = null;
                this.strangerId = null;
                this.isVideoEnabled = true;
                this.isAudioEnabled = true;
                
                this.init();
            }

            init() {
                this.connectSocket();
                this.setupEventListeners();
            }

            connectSocket() {
                this.socket = io();

                this.socket.on('connect', () => {
                    console.log('Connected to server with socket ID:', this.socket.id);
                    this.socket.emit('register-user', this.getProfileData());
                });

                this.socket.on('registration-success', ({ userId, onlineCount }) => {
                    this.userId = userId;
                    document.getElementById('onlineCount').textContent = onlineCount;
                    console.log('Registered with User ID:', this.userId);
                });

                this.socket.on('online-count-update', ({ count }) => {
                    document.getElementById('onlineCount').textContent = count;
                });

                this.socket.on('match-found', (data) => {
                    this.handleMatchFound(data);
                });

                this.socket.on('match-queued', (data) => {
                    this.showLoadingIndicator(data.message);
                });
                
                this.socket.on('chat-message', (data) => {
                    this.displayMessage(data.message, 'other');
                });
                
                this.socket.on('system-message', (data) => {
                    this.displayMessage(data.message, 'system');
                });

                this.socket.on('chat-ended', (data) => {
                    this.displayMessage(data.message, 'system');
                    this.showNotification('Chat ended.', 'info');
                    this.cleanup();
                    // Don't automatically return to setup, let user click "Next"
                });
                
                // WebRTC Listeners
                this.socket.on('webrtc-offer', async ({ offer, senderId }) => {
                    if (this.pc && senderId !== this.userId) {
                        await this.pc.setRemoteDescription(new RTCSessionDescription(offer));
                        const answer = await this.pc.createAnswer();
                        await this.pc.setLocalDescription(answer);
                        this.socket.emit('webrtc-answer', { answer, chatId: this.chatId });
                    }
                });

                this.socket.on('webrtc-answer', async ({ answer, senderId }) => {
                    if (this.pc && senderId !== this.userId) {
                        await this.pc.setRemoteDescription(new RTCSessionDescription(answer));
                    }
                });

                this.socket.on('ice-candidate', async ({ candidate, senderId }) => {
                    if (this.pc && senderId !== this.userId) {
                        await this.pc.addIceCandidate(new RTCIceCandidate(candidate));
                    }
                });
            }

            setupEventListeners() {
                document.querySelectorAll('.chat-type-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.chat-type-btn').forEach(b => b.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        this.chatType = e.currentTarget.dataset.type;
                    });
                });

                document.getElementById('startChatBtn').addEventListener('click', () => this.startChat());
                document.getElementById('endChatBtn').addEventListener('click', () => this.endChat());
                document.getElementById('nextChatBtn').addEventListener('click', () => this.nextChat());
                document.getElementById('sendBtn').addEventListener('click', () => this.sendMessage());
                document.getElementById('chatInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
                document.getElementById('toggleVideoBtn').addEventListener('click', () => this.toggleVideo());
                document.getElementById('toggleAudioBtn').addEventListener('click', () => this.toggleAudio());
            }

            getProfileData() {
                return {
                    gender: document.getElementById('genderFilter').value,
                    location: document.getElementById('locationFilter').value,
                    age: document.getElementById('ageFilter').value,
                    keywords: document.getElementById('keywordsFilter').value,
                };
            }

            async startChat() {
                const startBtn = document.getElementById('startChatBtn');
                startBtn.disabled = true;
                startBtn.textContent = 'Connecting...';

                document.getElementById('setupPanel').style.display = 'none';
                document.getElementById('chatContainer').style.display = 'block';

                if (this.chatType === 'video') {
                    await this.initializeMedia();
                }
                
                this.showLoadingIndicator('Looking for a match...');
                this.socket.emit('find-match', { ...this.getProfileData(), chatType: this.chatType });
            }

            async initializeMedia() {
                try {
                    this.localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    document.getElementById('localVideo').srcObject = this.localStream;
                    document.getElementById('videoContainer').classList.add('active');
                } catch (error) {
                    this.showNotification('Could not access camera/microphone.', 'error');
                    this.chatType = 'text'; // Fallback to text chat
                }
            }

            handleMatchFound(data) {
                this.hideLoadingIndicator();
                this.chatId = data.chatId;
                this.strangerId = data.stranger.id;

                document.getElementById('strangerStatus').textContent = 'Connected to a stranger.';
                document.getElementById('chatInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                
                if (data.chatType === 'video' && this.localStream) {
                    this.initializeWebRTC();
                }
            }

            async initializeWebRTC() {
                // Get WebRTC configuration from server
                const config = await this.getWebRTCConfig();
                this.pc = new RTCPeerConnection(config);
                
                this.localStream.getTracks().forEach(track => this.pc.addTrack(track, this.localStream));

                this.pc.ontrack = (event) => {
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                };

                this.pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        this.socket.emit('ice-candidate', { candidate: event.candidate, chatId: this.chatId });
                    }
                };

                this.pc.onconnectionstatechange = () => {
                    console.log('WebRTC connection state:', this.pc.connectionState);
                    if (this.pc.connectionState === 'failed') {
                        this.handleWebRTCFailure();
                    }
                };

                this.pc.oniceconnectionstatechange = () => {
                    console.log('ICE connection state:', this.pc.iceConnectionState);
                    if (this.pc.iceConnectionState === 'failed') {
                        this.handleWebRTCFailure();
                    }
                };
                
                const offer = await this.pc.createOffer();
                await this.pc.setLocalDescription(offer);
                this.socket.emit('webrtc-offer', { offer, chatId: this.chatId });
            }

            sendMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                if (!message || !this.chatId) return;

                this.displayMessage(message, 'own');
                this.socket.emit('chat-message', { message, chatId: this.chatId });
                input.value = '';
            }

            displayMessage(message, type) {
                const messagesContainer = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.textContent = message;
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            endChat() {
                if (this.chatId) {
                    this.socket.emit('end-chat');
                }
                this.cleanup();
                this.returnToSetup();
            }

            nextChat() {
                if (this.chatId) {
                    this.socket.emit('end-chat');
                }
                this.cleanup();
                this.startChat();
            }

            cleanup() {
                if (this.pc) {
                    this.pc.close();
                    this.pc = null;
                }
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => track.stop());
                    this.localStream = null;
                }
                
                this.chatId = null;
                this.strangerId = null;
                
                document.getElementById('remoteVideo').srcObject = null;
                document.getElementById('localVideo').srcObject = null;
                document.getElementById('videoContainer').classList.remove('active');
                document.getElementById('chatMessages').innerHTML = '';
                document.getElementById('chatInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
                document.getElementById('strangerStatus').textContent = 'Disconnected';
            }

            returnToSetup() {
                document.getElementById('chatContainer').style.display = 'none';
                document.getElementById('setupPanel').style.display = 'block';
                const startBtn = document.getElementById('startChatBtn');
                startBtn.disabled = false;
                startBtn.textContent = 'ðŸš€ Start Chatting';
            }
            
            toggleVideo() {
                if (!this.localStream) return;
                const videoTrack = this.localStream.getVideoTracks()[0];
                if (videoTrack) {
                    this.isVideoEnabled = !this.isVideoEnabled;
                    videoTrack.enabled = this.isVideoEnabled;
                    document.getElementById('toggleVideoBtn').textContent = this.isVideoEnabled ? 'ðŸ“¹' : 'ðŸ“¹âŒ';
                }
            }

            toggleAudio() {
                if (!this.localStream) return;
                const audioTrack = this.localStream.getAudioTracks()[0];
                if (audioTrack) {
                    this.isAudioEnabled = !this.isAudioEnabled;
                    audioTrack.enabled = this.isAudioEnabled;
                    document.getElementById('toggleAudioBtn').textContent = this.isAudioEnabled ? 'ðŸŽ¤' : 'ðŸŽ¤âŒ';
                }
            }
            
            async getWebRTCConfig() {
                try {
                    const response = await fetch('/api/config');
                    const config = await response.json();
                    return config.webrtcConfig || { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
                } catch (error) {
                    console.warn('Failed to get WebRTC config, using default:', error);
                    return { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
                }
            }

            handleWebRTCFailure() {
                console.warn('WebRTC connection failed, attempting to reconnect...');
                this.showNotification('Video connection issues detected. Trying to reconnect...', 'warning');
                
                // Attempt to restart WebRTC connection
                setTimeout(() => {
                    if (this.pc && this.pc.connectionState === 'failed') {
                        this.restartWebRTC();
                    }
                }, 2000);
            }

            async restartWebRTC() {
                try {
                    if (this.pc) {
                        this.pc.close();
                    }
                    
                    if (this.chatType === 'video' && this.localStream && this.chatId) {
                        await this.initializeWebRTC();
                        this.showNotification('Video connection restored', 'success');
                    }
                } catch (error) {
                    console.error('Failed to restart WebRTC:', error);
                    this.showNotification('Video connection could not be restored', 'error');
                }
            }
            
            showLoadingIndicator(message) {
                const indicator = document.getElementById('loadingIndicator');
                if (!indicator) {
                    const loadingHTML = `<div class="loading" id="loadingIndicator"><div class="spinner"></div><p>${message}</p></div>`;
                    document.getElementById('chatMessages').innerHTML = loadingHTML;
                } else {
                    indicator.querySelector('p').textContent = message;
                    indicator.style.display = 'block';
                }
            }

            hideLoadingIndicator() {
                const indicator = document.getElementById('loadingIndicator');
                if (indicator) indicator.style.display = 'none';
            }
            
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                setTimeout(() => notification.classList.add('show'), 10);
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => document.body.removeChild(notification), 300);
                }, 3000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new RandomChatApp();
            
            // Initialize ads
            initializeAds();
            
            // Initialize Google Analytics with dynamic ID
            initializeAnalytics();
        });
        
        // Ad initialization function
        function initializeAds() {
            try {
                // Load AdSense ads
                (adsbygoogle = window.adsbygoogle || []).push({});
                (adsbygoogle = window.adsbygoogle || []).push({});
                (adsbygoogle = window.adsbygoogle || []).push({});
                
                console.log('Ads initialized');
            } catch (error) {
                console.warn('Ad initialization failed:', error);
                // Show fallback content for ad spaces
                showAdFallbacks();
            }
        }
        
        // Show fallback content when ads fail to load
        function showAdFallbacks() {
            const adBanners = document.querySelectorAll('.ad-banner');
            adBanners.forEach(banner => {
                if (!banner.querySelector('.adsbygoogle[data-adsbygoogle-status]')) {
                    banner.innerHTML = '<div class="ad-placeholder">Advertisement</div>';
                }
            });
        }
        
        // Initialize Google Analytics with server-provided ID
        async function initializeAnalytics() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                if (config.googleAnalyticsId) {
                    gtag('config', config.googleAnalyticsId);
                    console.log('Google Analytics initialized with ID:', config.googleAnalyticsId);
                }
            } catch (error) {
                console.warn('Analytics initialization failed:', error);
            }
        }
        
        // Track custom events
        function trackEvent(action, category = 'User Interaction', label = '') {
            if (typeof gtag !== 'undefined') {
                gtag('event', action, {
                    event_category: category,
                    event_label: label
                });
            }
        }
        
        // Ad performance tracking
        function trackAdInteraction(adSlot, action) {
            trackEvent(action, 'Advertisement', adSlot);
        }
    </script>
</body>
</html>